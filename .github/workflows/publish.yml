name: publish

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-pack-publish:
    runs-on: [self-hosted, ajwin]

    env:
      VERSION: 1.0.${{ github.run_number }}
      PACK_ID: com.ajh.AndyTV
      PUBLISH_DIR: publish
      CHANNEL: win

      # ✅ .NET SDK installed inside the repo folder
      DOTNET_INSTALL_DIR: ${{ github.workspace }}\.dotnet

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET (local)
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Put local dotnet on PATH for this job
        shell: pwsh
        run: |
          "$env:DOTNET_INSTALL_DIR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "DOTNET_ROOT=$env:DOTNET_INSTALL_DIR" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Publish (self-contained)
        run: >
          dotnet publish ./AndyTV/AndyTV.csproj
          --self-contained true
          -p:Version=$env:VERSION
          -o $env:PUBLISH_DIR

      # ✅ Local tool manifest (creates ./.config/dotnet-tools.json)
      - name: Ensure tool manifest exists
        shell: pwsh
        run: |
          if (!(Test-Path ".\.config\dotnet-tools.json")) {
            dotnet new tool-manifest
          }

      # ✅ Install vpk as a LOCAL tool (not global)
      - name: Install vpk (local tool)
        run: dotnet tool install vpk

      - name: Restore local tools
        run: dotnet tool restore

      - name: Download latest from GitHub Releases (for deltas)
        run: >
          dotnet tool run vpk download github
          --repoUrl https://github.com/${{ github.repository }}
          --channel $env:CHANNEL
          --token ${{ secrets.GITHUB_TOKEN }}

      - name: Pack Velopack release
        run: >
          dotnet tool run vpk pack
          --packId $env:PACK_ID
          --packVersion $env:VERSION
          --packDir $env:PUBLISH_DIR
          --mainExe AndyTV.exe
          --packTitle "AndyTV"
          --icon ./AndyTV/AndyTV.ico
          --channel $env:CHANNEL

      - name: Upload to GitHub Releases (Velopack)
        run: >
          dotnet tool run vpk upload github
          --outputDir Releases
          --channel $env:CHANNEL
          --repoUrl https://github.com/${{ github.repository }}
          --publish
          --tag v$env:VERSION
          --releaseName "AndyTV $env:VERSION"
          --token ${{ github.token }}
