name: publish

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-pack-publish:
    runs-on: [self-hosted, ajwin]

    steps:
      # Clone the repository (checkout automatically cleans the workspace first)
      - uses: actions/checkout@v4

      # Install .NET SDKs locally in workspace to avoid conflicts with system installations
      # NET 9 is required for vpk tool
      - name: Setup .NET (local install)
        uses: actions/setup-dotnet@v5
        env:
          DOTNET_INSTALL_DIR: ${{ github.workspace }}\.dotnet
        with:
          dotnet-version: |
            10.0.x
            9.0.x

      # Configure environment to use the locally installed .NET instead of system version
      - name: Add local dotnet to PATH
        shell: powershell
        run: |
          "${{ github.workspace }}\.dotnet" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "DOTNET_ROOT=${{ github.workspace }}\.dotnet" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # Build self-contained executable with all dependencies bundled (no .NET runtime required)
      - name: Publish (self-contained win-x64)
        shell: powershell
        run: |
          $version = "1.0.${{ github.run_number }}"
          dotnet publish .\AndyTV\AndyTV.csproj -c Release -r win-x64 --self-contained true -p:Version=$version -o publish

      # Use Velopack (vpk) to create installer, download previous release, and publish new version to GitHub
      - name: Install vpk (local tool) + run
        shell: powershell
        run: |
          $version = "1.0.${{ github.run_number }}"

          if (!(Test-Path ".\.config\dotnet-tools.json")) { dotnet new tool-manifest }

          dotnet tool install vpk
          dotnet tool restore

          dotnet tool run vpk download github `
            --repoUrl https://github.com/${{ github.repository }} `
            --channel win `
            --token ${{ github.token }}

          dotnet tool run vpk pack `
            --packId com.ajh.AndyTV `
            --packVersion $version `
            --packDir publish `
            --mainExe AndyTV.exe `
            --packTitle "AndyTV" `
            --icon .\AndyTV\AndyTV.ico `
            --channel win

          dotnet tool run vpk upload github `
            --outputDir Releases `
            --channel win `
            --repoUrl https://github.com/${{ github.repository }} `
            --publish `
            --tag v$version `
            --releaseName "AndyTV $version" `
            --token ${{ github.token }}
