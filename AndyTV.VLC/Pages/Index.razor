@page "/"
@inject VlcService Vlc
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Elevation="1">
    <MudText Typo="Typo.h5" Class="mb-3">IPTV Playlist Loader</MudText>
    <MudTextField @bind-Value="_playlistUrl" Label="M3U URL" Placeholder="https://.../playlist.m3u" Variant="Variant.Outlined" Class="mb-2" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_loading || string.IsNullOrWhiteSpace(_playlistUrl)" OnClick="LoadPlaylistAsync">Load Playlist</MudButton>
    <MudTextField @bind-Value="_search" Label="Search Channels" Placeholder="Type to filter" Variant="Variant.Outlined" Class="mt-4 mb-2" Immediate="true" OnInput="RefreshTable" />

    <MudTable ServerData="LoadServerData" Filter="TableFilter" Hover="true" Dense="true" Bordered="true" Breakpoint="Breakpoint.Sm" @ref="_table">
        <HeaderContent>
            <MudTh>Logo</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Group</MudTh>
            <MudTh>Play</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Logo">
                @if (!string.IsNullOrWhiteSpace(context.Logo))
                {
                    <MudAvatar Size="Size.Medium">
                        <MudImage Src="@context.Logo" Alt="@context.Title" />
                    </MudAvatar>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Tv" />
                }
            </MudTd>
            <MudTd DataLabel="Name">@context.Title</MudTd>
            <MudTd DataLabel="Group">@context.GroupTitle</MudTd>
            <MudTd DataLabel="Play">
                <MudIconButton Icon="@Icons.Material.Filled.Tv" Color="Color.Primary" OnClick="(()=>PlayChannel(context))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" Class="mt-3" />
    }
</MudPaper>

@code {
    private string _playlistUrl = string.Empty;
    private string _search = string.Empty;
    private bool _loading = false;
    private List<Channel> _channels = new();
    private MudTable<Channel>? _table;

    private async Task LoadPlaylistAsync()
    {
        _loading = true;
        StateHasChanged();
        try
        {
            var parsed = await M3UManager.ParseFromUrlAsync(_playlistUrl);
            _channels = parsed.Channels.ToList();
            Snackbar.Add($"Loaded {_channels.Count} channels", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load playlist: " + ex.Message, Severity.Error);
        }
        finally
        {
            _loading = false;
            await _table!.ReloadServerData();
        }
    }

    private async Task<TableData<Channel>> LoadServerData(TableState state)
    {
        IEnumerable<Channel> query = _channels;
        if (!string.IsNullOrWhiteSpace(_search))
        {
            query = query.Where(c => (c.Title?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false) || (c.GroupTitle?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false));
        }
        var total = query.Count();
        query = query.Skip(state.Page * state.PageSize).Take(state.PageSize);
        return await Task.FromResult(new TableData<Channel> { Items = query.ToList(), TotalItems = total });
    }

    private bool TableFilter(Channel channel) => true; // We handle filtering manually in LoadServerData

    private void RefreshTable(ChangeEventArgs args)
    {
        _ = _table?.ReloadServerData();
    }

    private void PlayChannel(Channel c)
    {
        if (Vlc.Launch(c.MediaUrl))
            Snackbar.Add($"Launching VLC: {c.Title}", Severity.Info);
        else
            Snackbar.Add("Could not launch VLC (check path in appsettings).", Severity.Warning);
    }
}